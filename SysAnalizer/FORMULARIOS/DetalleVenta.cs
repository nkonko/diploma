// <auto-generated/>
namespace UI
{
    using BE.Entidades;
    using BLL;
    using System;
    using System.Windows.Forms;

    public partial class VtaProd : Form, IVtaProd
    {
        private readonly IVentaBLL ventaBLL;
        private readonly IProductoBLL productoBLL;
        private readonly IProductos productos;
        private readonly IClienteBLL clienteBLL;
        private readonly IClientes cliente;
        private readonly IFormControl formControl;

        public Cliente ClienteSeleccionado { get; set; } = new Cliente();
        public Producto ProductoSeleccionado { get; set; } = new Producto();
        public Venta VentaSeleccionada { get; set; } = new Venta();
        public Usuario UsuarioActivo { get; set; } = new Usuario();

        public VtaProd(IVentaBLL ventaBLL, IProductoBLL productoBLL, IProductos productos, IClienteBLL clienteBLL, IClientes cliente, IFormControl formControl)
        {
            this.ventaBLL = ventaBLL;
            this.productoBLL = productoBLL;
            this.productos = productos;
            this.cliente = cliente;
            this.clienteBLL = clienteBLL;
            this.formControl = formControl;
            InitializeComponent();
            RecargarDatagrid();
        }

        public enum TipoVenta
        {
            Seña = 1,
            VentaSimple,
            Cliente,
            Devolucion,
        }

        private void dataGridView1_CellContentClick(object sender, DataGridViewCellEventArgs e)
        {
            SetearVentaSeleccionada();
        }

        private void SetearVentaSeleccionada()
        {
            VentaSeleccionada = (Venta)dgVenta.CurrentRow.DataBoundItem;
        }

        private void VtaProd_Load(object sender, EventArgs e)
        {
            UsuarioActivo = formControl.ObtenerInfoUsuario();
        }

        private void btnAgregarProducto_Click(object sender, EventArgs e)
        {
            if (radioVtaSimple.Checked)
            {
                ventaBLL.Crear(CrearNuevaVenta(ClienteSeleccionado.ClienteId, 2, DateTime.UtcNow, int.Parse(txtCant.Text) * ProductoSeleccionado.PVenta, 2, UsuarioActivo.UsuarioId, ProductoSeleccionado));
                radioVtaCC.Enabled = false;
                rbSe.Enabled = false;
            }

            if (radioVtaCC.Checked)
            {
                ventaBLL.Crear(CrearNuevaVenta(ClienteSeleccionado.ClienteId, 1, DateTime.UtcNow, int.Parse(txtCant.Text) * ProductoSeleccionado.PVenta, 3, UsuarioActivo.UsuarioId, ProductoSeleccionado));
                radioVtaSimple.Enabled = false;
                rbSe.Enabled = false;
            }

            if (rbSe.Checked)
            {
                ventaBLL.Crear(CrearNuevaVenta(ClienteSeleccionado.ClienteId, 1, DateTime.UtcNow, int.Parse(txtCant.Text) * ProductoSeleccionado.PVenta, 1, UsuarioActivo.UsuarioId, ProductoSeleccionado));
                radioVtaSimple.Enabled = false;
                radioVtaCC.Enabled = false;
            }

            RecargarDatagrid();
        }

        private Venta CrearNuevaVenta(int clienteId, int estadoId, DateTime fecha, float monto, int tipoVta, int usuarioId, Producto producto)
        {
            return new Venta()
            {
                ClienteId = clienteId,
                EstadoId = estadoId,
                Fecha = fecha,
                Monto = monto,
                TipoVentaId = tipoVta,
                UsuarioId = usuarioId,
                Producto = producto
            };
        }

        private void RecargarDatagrid()
        {
            dgVenta.DataSource = null;
            dgVenta.DataSource = ventaBLL.Cargar();
        }

        private void btnVolver_Click(object sender, EventArgs e)
        {
            this.Hide();
        }

        private void btnSelCliente_Click(object sender, EventArgs e)
        {
            var resultado = cliente.ShowDialog();

            if (resultado == DialogResult.OK)
            {
                ClienteSeleccionado = cliente.ObtenerClienteSeleccionado();
                lblCliente.Text += ClienteSeleccionado.NombreCompleto;
                radioVtaCC.Enabled = true;
                radioVtaCC.Checked = true;
            }
            else
            {
                radioVtaCC.Enabled = false;
                radioVtaCC.Checked = false;
            }
        }

        private void btnSelProd_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txtCodProd.Text))
            {
                var resultado = productos.ShowDialog();
                if (resultado == DialogResult.OK)
                {
                    ProductoSeleccionado = productos.ObtenerProductoSeleccionado();
                }
            }
            else
            {
                ProductoSeleccionado = productoBLL.ObtenerProductoPorCodigo(txtCodProd.Text);
            }
        }

        private void VtaProd_FormClosing(object sender, FormClosingEventArgs e)
        {
            Hide();
            e.Cancel = true;
        }

        private void btnCancelarVta_Click(object sender, EventArgs e)
        {
            ClienteSeleccionado = null;
            ProductoSeleccionado = null;
            txtCant.Text = "";
            txtCodProd.Text = "";
            radioVtaCC.Enabled = true;
            radioVtaSimple.Enabled = true;
            rbSe.Enabled = true;
        }

        private void btnFinalizarVenta_Click(object sender, EventArgs e)
        {
            ClienteSeleccionado = null;
            ProductoSeleccionado = null;
            txtCant.Text = "";
            txtCodProd.Text = "";
            radioVtaCC.Enabled = true;
            radioVtaSimple.Enabled = true;
            rbSe.Enabled = true;
        }
    }
}
