// <auto-generated/>
namespace UI
{
    using BE.Entidades;
    using BLL;
    using DAL.Dao;
    using System;
    using System.Windows.Forms;

    public partial class Login : Form
    {
        private const string nombreForm = "Login";

        private log4net.ILog log;
        private IPrincipal PrincipalForm;
        private IUsuarioBLL usuarioBLL;
        private IFormControl formControl;
        private readonly IIdiomaBLL idiomaBLL;
        private readonly IDigitoVerificador digitoVerificador;
        private readonly ITraductor traductor;

        public Login(IIdiomaBLL idiomaBLL, IDigitoVerificador digitoVerificador, ITraductor traductor)
        {
            this.digitoVerificador = digitoVerificador;
            this.idiomaBLL = idiomaBLL;
            this.traductor = traductor;
            InitializeComponent();
            txt_contraseña.PasswordChar = '*';
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            this.AcceptButton = btn_ingresar;
            log = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);
            PrincipalForm = IoCContainer.Resolve<IPrincipal>();
            usuarioBLL = IoCContainer.Resolve<IUsuarioBLL>();
            formControl = IoCContainer.Resolve<IFormControl>();
            CargarCombo();
            formControl.LenguajeSeleccionado = (Idioma)cbo_idioma.SelectedItem;
            Traduccir();
            ComprobarBaseDeDatos();
        }

        private void ComprobarBaseDeDatos()
        {
            if (!digitoVerificador.ComprobarIntegridad())
            {
                ////traducir
                Alert.ShowSimpleAlert("Problema integridad base de datos, contacte al administrador", "MSJ000");

                this.Close();

            }
        }

        private void Traduccir()
        {
            traductor.Traduccir(this, nombreForm);
        }

        private void CargarCombo()
        {
            var idioma = idiomaBLL.ObtenerTodosLosIdiomas();
            cbo_idioma.DataSource = idioma;
            cbo_idioma.ValueMember = "IdIdioma";
            cbo_idioma.DisplayMember = "Descripcion";
            cbo_idioma.SelectedIndex = 0;
        }

        private void btn_ingresar_Click(object sender, EventArgs e)
        {
            this.CatchException(() =>
            {
                var usuario = txt_user.Text;
                var contraseña = txt_contraseña.Text;
                ////admin123

                if (usuarioBLL.ObtenerUsuarioConEmail(usuario).Activo)
                {
                    var ingresa = usuarioBLL.LogIn(usuario, contraseña);

                    if (ingresa)
                    {
                        this.Hide();
                        formControl.GuardarDatosSesionUsuario(usuarioBLL.ObtenerUsuarioConEmail(usuario));
                        PrincipalForm.ComprobarSiEsPrimerLogin(usuario);
                        PrincipalForm.Show();
                    }

                    else if (usuarioBLL.ObtenerUsuarioConEmail(usuario).ContadorIngresosIncorrectos < 3)
                    {
                        MessageBox.Show("Login Incorrecto");
                    }
                    else
                    {
                        MessageBox.Show("Cuenta bloqueada contacte a su administrador");
                    }
                }
                else
                {
                    MessageBox.Show("Su usuario no se encuentra activo");
                }
            },
            (ex) => MessageBox.Show($"Ocurrio un error por lo siguiente {ex.Message}"));
        }

        private void cbo_idioma_SelectedIndexChanged(object sender, EventArgs e)
        {
            var lenguajeSeleccionado = (Idioma)cbo_idioma.SelectedItem;

            formControl.LenguajeSeleccionado = lenguajeSeleccionado;

            Traduccir();
        }

        private void btn_salir_Click(object sender, EventArgs e)
        {
            if (Alert.ConfirmationMessage("MSJ001", "Seguro que desea salir?", MessageBoxButtons.YesNo) == DialogResult.Yes)
            {
                this.Close();
            }
        }
    }
}
