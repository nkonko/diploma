// <auto-generated/>
namespace UI
{
    using BE.Entidades;
    using BLL;
    using Microsoft.VisualBasic;
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Windows.Forms;

    public partial class Familias : Form, IFamilias
    {
        public Familia familiaSeleccionada = null;
        private readonly IFamiliaBLL familiaBLL;
        private readonly IAdminPatFamilia adminPatFamilia;

        public Familias(IFamiliaBLL familiaBLL, IUsuarioBLL usuarioBLL, IAdminPatFamilia adminPatFamilia)
        {
            InitializeComponent();
            this.familiaBLL = familiaBLL;
            this.adminPatFamilia = adminPatFamilia;
        }

        private void Familias_Load(object sender, EventArgs e)
        {
            CargarFamilias();

        }

        private void CargarFamilias()
        {
            var descripciones = new List<string>();

            foreach (var familia in familiaBLL.Cargar())
            {
                descripciones.Add(familia.Descripcion);
            }

            chklstFamilias.DataSource = descripciones;
        }

        private void btnNueva_Click(object sender, EventArgs e)
        {
            var nombreFamilia = Interaction.InputBox("Ingrese el nombre para la nueva familia", "Nueva familia", "");
            var familias = familiaBLL.Cargar();

            if (!familias.Select(x => x.Descripcion).Contains(nombreFamilia))
            {
                var creada = familiaBLL.Crear(new Familia() { Descripcion = nombreFamilia });
                var creadaId = familiaBLL.ObtenerIdFamiliaPorDescripcion(nombreFamilia);

                familiaSeleccionada = new Familia() { FamiliaId = creadaId, Descripcion = nombreFamilia };

                if (creada)
                {
                    adminPatFamilia.FamiliaNueva = true;

                    var resultado = adminPatFamilia.ShowDialog();

                    if (resultado == DialogResult.OK)
                    {
                        MessageBox.Show("Familia y Patentes registradas");
                    }
                }

                CargarFamilias();
                chklstFamilias.Refresh();
            }
            else
            {
                MessageBox.Show("La familia ya existe");
            }
        }

        public Familia ObtenerFamiliaSeleccionada()
        {
            return familiaSeleccionada;
        }

        private void btnBaja_Click(object sender, EventArgs e)
        {
            var desc = chklstFamilias.SelectedItem.ToString();

            var exitoso = familiaBLL.Borrar(new Familia() { Descripcion = desc, FamiliaId = familiaBLL.ObtenerIdFamiliaPorDescripcion(desc) });

            if (!exitoso)
            {
                MessageBox.Show("La familia actualmente esta en uso");
            }

            CargarFamilias();
            chklstFamilias.Refresh();
        }

        private void btnModificar_Click(object sender, EventArgs e)
        {
            var desc = chklstFamilias.SelectedItem.ToString();
            var nuevoNombre = Interaction.InputBox("Ingrese el nombre:", "Actualizar", "");

            var familias = familiaBLL.Cargar();

            if (!familias.Select(x => x.Descripcion).Contains(nuevoNombre))
            {
                var exitoso = familiaBLL.Actualizar(new Familia() { Descripcion = nuevoNombre, FamiliaId = familiaBLL.ObtenerIdFamiliaPorDescripcion(desc) });
                var creadaId = familiaBLL.ObtenerIdFamiliaPorDescripcion(nuevoNombre);

                familiaSeleccionada = new Familia() { FamiliaId = creadaId, Descripcion = nuevoNombre };

                if (exitoso)
                {
                    adminPatFamilia.FamiliaNueva = true;
                    var resultado = adminPatFamilia.ShowDialog();
                    if (resultado == DialogResult.OK)
                    {
                        MessageBox.Show("Familia y Patentes Actualizadas");
                    }
                }

                CargarFamilias();
                chklstFamilias.Refresh();
            }
            else
            {
                MessageBox.Show("La familia ya existe");
            }
            CargarFamilias();
            chklstFamilias.Refresh();
        }
    }
}